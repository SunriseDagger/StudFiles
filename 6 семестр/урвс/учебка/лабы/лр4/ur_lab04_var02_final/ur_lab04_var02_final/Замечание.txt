Во второй части, если не будет работать, заменить везде

    usleep(10000);

на что нибудь побольше.

А лучше вообще не использовать sleep / usleep, а переделать на нормальные сигналы.

