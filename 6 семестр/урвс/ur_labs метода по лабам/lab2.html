<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>

 <head>
  <title>Лабораторная работа № 2</title>
  <meta http-equiv=Content-Type content="text/html; charset=windows-1251">
  <meta content="MSHTML 6.00.2900.2180" name=generator>
  <link rel="stylesheet" type="text/css" href="textstyle.css">
  <!--base href="http://ami.nstu.ru/~vms/method6/"-->
 </head>

 <body>

  <div class="header">
   Лабораторная работа № 2
  </div>
  <div class="mainheader">
   Файловая система ОС UNIX
  </div>
  
  <div class="header">
   Цель работы
  </div>
  <div class="abzac">
   Ознакомиться с файловой системой ОС UNIX, механизмами ее функционирования, основными элементами файловой системы: 
   суперблок, описатели файлов, типы файлов, список свободных описателей файлов, список свободных блоков.
  </div>
  
  <div class="header">
   Содержание работы
  </div>
  <ol>
   <li>
    Ознакомиться с файловой системой ОС UNIX и программными средствами работы с ней. 
   </li>
   <li>
    Ознакомиться с заданием к лабораторной работе. 
   </li>
   <li>
    Для указанного варианта составить программу на языке Си, реализующую требуемые действия. 
   </li>
   <li>
    Отладить и оттестировать составленную программу, используя инструментарий ОС UNIX. 
   </li>
   <li>
    Защитить лабораторную работу, ответив на контрольные вопросы.
   </li>
  </ol>

  <div class="header">
   Методические указания к лабораторной работе
  </div>
  <div class="abzac">
   Интерфейс между пользовательской программой и внешним устройством (или между двумя пользовательскими программами) в 
   ОС UNIX осуществляется в рамках единой структуры данных, называемой файлом ОС UNIX.
  </div>
  <div class="abzac">
   Всякий файл ОС UNIX в соответствие с его типом может быть отнесен к одной из следующих четырех групп: обычные файлы, 
   каталоги, специальные файлы, каналы.
  </div>
  <div class="abzac">
   Обычный файл представляет собой совокупность блоков диска, входящих в состав файловой системы ОС UNIX. В указанных 
   блоках может быть произвольная информация.
  </div>
  <div class="abzac">
   Каталоги представляют собой файлы особого типа, отличающиеся от обычных, прежде всего, тем, что осуществить запись в 
   них может только ядро ОС UNIX, в то время как доступ по чтению может получить любой пользовательский процесс, имеющий 
   соответствующие полномочия. Каждый элемент каталога состоит из двух полей: поля имени файла и поля, содержащего указатель 
   на описатель файла, где хранится вся информация о файле: дата создания, размер, код защиты, имя владельца и т.д. В 
   любом каталоге содержится, по крайней мере, два элемента, содержащие в поле имени файла имена <span class="code">"."</span> 
   и <span class="code">".."</span>. Элемент каталога, содержащий в поле имени файла контекст <span class="code">"."</span>, 
   в поле ссылки содержит ссылку на описатель файла, описывающий этот каталог. Элемент каталога, содержащий в поле имени 
   файла контекст <span class="code">".."</span>, в поле ссылки содержит ссылку на описатель 
   файла, в котором хранится информация о родительском каталоге текущего каталога.
  </div>
  <div class="abzac">
   Специальные файлы - это некоторые файлы, каждому из которых ставится в соответствие свое внешнее устройство, поддерживаемое 
   ОС UNIX и имеющее специальную структуру. Его нельзя использовать для хранения данных, как обычный файл или каталог. В то 
   же время над специальным файлом можно производить те же операции, что и над обычным файлом: открывать, вводить и/или выводить 
   информацию и т.д. Результат применения любой из этих операций зависит от того, какому конкретному устройству соответствует 
   обрабатываемый специальный файл, однако в любом случае будет осуществлена соответствующая операция ввода-вывода на внешнее 
   устройство, которому соответствует выбранный специальный файл.
  </div>
  <div class="abzac">
   Четвертый вид файлов - каналы - будет рассмотрен отдельно в последующих лабораторных работах.
  </div>
  
  <div class="header">
   Cистемные функции ОС UNIX для работы с файловой системой
  </div>
  <table>
   <tr>
    <td>
     Возвращают дескриптор файла
    </td>
    <td>
     <span class="code">open, creat, dup, pipe, close</span>
    </td>
   </tr>

   <tr>
    <td>
     Преобразуют имя в описатель
    </td>
    <td>
     <span class="code">open, creat, chdir, chmod, stat, mkfifo, mound, mknod, link, unmount, unlink, chown</span>
    </td>
   </tr>

   <tr>
    <td>
     Назначают inode
    </td>
    <td>
     <span class="code">creat, link, unlink, mknod</span>
    </td>
   </tr>

   <tr>
    <td>
     Работают с атрибутами
    </td>
    <td>
     <span class="code">chown, chmod, stat</span>
    </td>
   </tr>

   <tr>
    <td>
     Ввод/вывод из файла
    </td>
    <td>
     <span class="code">read, write, lseek</span>
    </td>
   </tr>

   <tr>
    <td>
     Работают со структурой файловой системы
    </td>
    <td>
     <span class="code">mount, unmount</span>
    </td>
   </tr>

   <tr>
    <td>
     Управляют деревьями
    </td>
    <td>
     <span class="code">chmod, chown</span>
    </td>
   </tr>
  </table>

  <div class="abzac">
   Остановимся на тех из них, которые требуются для выполнения лабораторной работы. Для получения информации о типе 
   файла необходимо воспользоваться системными вызовами <span class="code">stat()</span> (<span class="code">fstat()</span>). 
   Формат системных вызовов <span class="code">stat()</span> (<span class="code">fstat()</span>):
  </div>
<pre>
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;

int stat(const char *name, struct stat *stbuf);
int fstat(int fd, struct stat *stbuf);  
</pre>
  <div class="abzac">
   Оба системных вызова помещают информацию о файле (в первом случае специфицированном именем name, а во втором - 
   дескриптором файла fd) в структурную переменную, на которую указывает stbuf. Вызывающая функция должна позаботиться 
   о резервировании места для возвращаемой информации; в случае успеха возвращается 0, в противном случае -1 и код ошибки 
   в <span class="code">errno</span>. Описание структуры stat содержится в файле <span class="code">sys/stat.h</span>. 
   С небольшими модификациями она имеет вид:
  </div>
<pre>
struct stat
{
 dev_t st_dev;    /* device file */
 ino_t st_ino;    /* file serial inode */
 ushort st_mode;  /* file mode */
 short st_nlink;  /* number of links */
 ushort st_uid;   /* user ID */
 ushort st_gid;   /* group ID */
 dev_t st_rdev;   /* device ident */
 off_t st_size;   /* size of file */
 time_t st_atime; /* last access time */
 time_t st_mtime; /* last modify time */
 time_t st_ctime; /* last status change */
};
</pre>
  <div class="abzac">
   Поле <span class="code">st_mode</span> содержит флаги, описывающие файл. Флаги несут следующую информацию:
  </div>
<pre>
S_IFMT   0170000 &ndash; <span class="mainfont">тип файла</span>
S_IFDIR  0040000 &ndash; <span class="mainfont">каталог</span>
S_IFCHR  0020000 &ndash; <span class="mainfont">байт-ориентированный специальный файл</span>
S_IFBLK  0060000 &ndash; <span class="mainfont">блок-ориентированный специальный файл</span>
S_IFREG  0100000 &ndash; <span class="mainfont">обычный файл</span>
S_IFFIFO 0010000 &ndash; <span class="mainfont">дисциплина FIFO</span>
S_ISUID  04000   &ndash; <span class="mainfont">идентификатор владельца</span>
S_ISGID  02000   &ndash; <span class="mainfont">идентификатор группы</span>
S_ISVTX  01000   &ndash; <span class="mainfont">сохранить свопируемый текст</span>
S_ISREAD 00400   &ndash; <span class="mainfont">владельцу разрешено чтение</span>
S_IWRITE 00200   &ndash; <span class="mainfont">владельцу разрешена запись</span>
S_IEXEC  00100   &ndash; <span class="mainfont">владельцу разрешено выполнение</span>
</pre>
  <div class="abzac">
   Символьные константы, четыре первых символа которых совпадают с контекстом <span class="code">S_IF</span>, 
   могут быть использованы для определения типа файла.
  </div>
  <div class="abzac">
   Большинство системных вызовов, работающих с каталогами, оперируют структурой <span class="code">dirent</span>, 
   определенной в заголовочном файле <span class="code">&lt;dirent.h&gt;</span>.
  </div>
<pre>
struct dirent
{
 ino_t d_ino;         /* номер индексного дескриптора */
 char d_name[DIRSIZ]; /* имя файла */
}
</pre>
  <div class="abzac">
   Создание и удаление каталога выполняется системными вызовами <span class="code">mkdir()</span> и 
   <span class="code">rmdir()</span>. При создании каталога посредством системного вызова <span class="code">mkdir()</span> 
   в него помещается две ссылки (<span class="code">"."</span> и <span class="code">".."</span>).
  </div>
<pre>
#include &lt;sys/types.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;unistd.h&gt;
int mkdir (char *pathname, mode_t mode);
int rmdir (char *pathname);
</pre>
  <div class="abzac">
   Открытие и закрытие каталога выполняется системными вызовами <span class="code">opendir()</span> и 
   <span class="code">closedir()</span>. При успешном открытии каталога системный вызов возвращает указатель 
   на переменную типа <span class="code">DIR</span>, являющуюся дескриптором каталога, определенную в файле 
   <span class="code">dirent.h</span> и используемую при чтении и записи в каталог. При неудачном вызове возвращается 
   значение <span class="code">NULL</span>.
  </div>
<pre>
#include &lt;sys/types.h&gt;
#include &lt;dirent.h&gt;
DIR *opendir (char *dirname);
int closedir (DIR *dirptr);   /* dirptr - дескриптор каталога */
</pre>
  <div class="abzac">
   Для смены каталога служит системный вызов <span class="code">chdir()</span>: 
  </div>
<pre>#include &lt;unistd.h&gt;
int chdir (char *pathname);
</pre>
  <div class="abzac">
   Чтение записей каталога выполняется системным вызовом <span class="code">readdir()</span>. Системный вызов 
   <span class="code">readdir()</span> по номеру дескриптора каталога возвращает очередную запись из каталога в структуру 
   <span class="code">dirent</span>, либо нулевой указатель при достижении конца каталога. При успешном чтении, указатель 
   каталога перемещается к следующей записи. Дополнительный системный вызов <span class="code">rewinddir()</span> переводит 
   указатель каталога к первой записи каталога.
  </div>
<pre>
#include &lt;sys/types.h&gt;
#include &lt;dirent.h&gt;
struct dirent *readdir (DIR *dirptr);
void rewinddir (DIR *dirptr);
</pre>

  <div class="header">
   Варианты заданий
  </div>
  <ol>
   <li>
    Разработать программу, которая осуществляет просмотр текущего каталога и выводит на экран его содержимое группами в
    порядке возрастания числа ссылок на файлы (в том числе имена каталогов). Группа представляет собой объединение файлов 
    с одинаковым числом ссылок на них. 
   </li>

   <li>
    Разработать программу, которая просматривает текущий каталог и выводит на экран имена всех встретившихся в нем файлов с 
    заданным расширением. Затем осуществляется переход в родительский каталог, который затем становится текущим, и указанные 
    выше действия повторяются до тех пор, пока текущим каталогом не станет корневой каталог.
   </li>

   <li>
    Разработать программу, которая просматривает текущий каталог и выводит на экран имена всех встретившихся в нем 
    обычных файлов. Затем осуществляется переход в родительский каталог, который затем становится текущим, и указанные 
    выше действия повторяются до тех пор, пока текущим каталогом не станет корневой каталог. 
   </li>

   <li>
    Разработать программу, которая выводит на экран имена тех каталогов, которые находятся в текущем каталоге и не содержат 
    в себе подкаталогов. 
   </li>

   <li>
    Разработать программу, которая выводит на экран имена тех каталогов, которые находятся в текущем каталоге и содержат в себе 
    подкаталоги. 
   </li>

   <li>
    Разработать программу, которая выводит на экран содержимое текущего каталога, упорядоченное по времени создания файлов. 
    При этом имена каталогов должны выводиться последними. 
   </li>

   <li>
    Разработать программу, которая выводит на экран содержимое текущего каталога в порядке возрастания размеров файлов. 
    При этом имена каталогов должны выводиться первыми. 
   </li>

   <li>
    Разработать программу, которая выводит на экран содержимое текущего каталога в алфавитном порядке. Каталоги не выводить. 
   </li>

   <li>
    Разработать программу, которая просматривает текущий каталог и выводит на экран имена всех встретившихся в нем 
    каталогов. Затем осуществляется переход в родительский каталог, который затем становится текущим, и указанные 
    выше действия повторяются до тех пор, пока текущим каталогом не станет корневой каталог. 
   </li>

   <li>
    Разработать программу, которая осуществляет просмотр текущего каталога и выводит на экран имена находящихся в нём 
    каталогов, упорядочив их по числу файлов и каталогов, содержащихся в отображаемом каталоге. Для каждого такого каталога 
    указывается число содержащихся в нём файлов и каталогов.
   </li>
  </ol>

  <div class="header">
   Контрольные вопросы
  </div>
  <ol>
   <li>
    Что представляет собой суперблок?
   </li>
   <li>
    Что представляет собой список свободных блоков?
   </li>
   <li>
    Что представляет собой список свободных описателей файлов?
   </li>
   <li>
    Как производится выделение свободных блоков под файл?
   </li>
   <li>
    Как производится освобождение блоков данных, занятых под файл?
   </li>
   <li>
    Каким образом осуществляется монтирование дисковых устройств?
   </li>
   <li>
    Каково назначение элементов структуры <span class="code">stat</span>?
   </li>
   <li>
    Каким образом осуществляется защита файлов в ОС UNIX?
   </li>
   <li>
    Каковы права доступа к файлу, при которых владелец может выполнять все операции (r, w, x), а прочие пользователи - 
    только читать?
   </li>
   <li>
    Что выполняет системный вызов <span class="code">lseek(fd, (off_t)0, SEEK_END)</span>?
   </li>
  </ol>

 </body>
</html>
